<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>Run Streak Private</title>
<style>
body { font-family: Arial; background:#0f172a; color:white; text-align:center; }
h1 { color:#38bdf8; }
input { padding:8px; font-size:16px; width:120px; margin:4px; }
button { padding:8px 14px; font-size:15px; border:none; border-radius:6px; cursor:pointer; margin:3px; }
.chain { display:flex; flex-wrap:wrap; justify-content:center; max-width:800px; margin:30px auto; gap:8px; }
.day { width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; }
.green { background:#22c55e; }
.red { background:#7f1d1d; }
.progressBar { width:100%; height:20px; background:#334155; border-radius:10px; overflow:hidden; margin-top:5px; }
.progressFill { height:100%; width:0%; background:#22c55e; }
</style>
</head>
<body>

<h1>沐 Run Streak (Private)</h1>

<div id="authBox">
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="M蘯ｭt kh蘯ｩu"><br>
  <button id="loginBtn">沐 ﾄ斉ハg nh蘯ｭp</button>
  <button id="googleBtn">沐 ﾄ斉ハg nh蘯ｭp Google</button>
</div>

<button id="logoutBtn" style="display:none;">泅ｪ ﾄ斉ハg xu蘯･t</button>

<div id="app" style="display:none;">
  <div>T盻貧g km: <span id="totalKm">0</span> | Streak: <span id="streak">0</span> 沐･</div>

  沁ｯ Thﾃ｡ng nﾃy: <span id="monthKm">0</span> /
  <input type="number" id="goalInput" style="width:70px"> km
  <div class="progressBar"><div class="progressFill" id="progressFill"></div></div>

  <input type="date" id="dateInput">
  <input type="number" id="kmInput" placeholder="Km">
  <input type="number" id="timeInput" placeholder="Phﾃｺt">
  <button onclick="addRun()">Lﾆｰu</button>

  <div class="chain" id="chain"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut,
signInWithEmailAndPassword } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCgwqXrG0MzYZxWHmaNgcAE1h5HG0zNhSI",
  authDomain: "runm2026.firebaseapp.com",
  projectId: "runm2026",
  storageBucket: "runm2026.firebasestorage.app",
  messagingSenderId: "353845948909",
  appId: "1:353845948909:web:b0d3c35408009119a7b7e4"
};

const ALLOWED_EMAILS = [
  "2051200028@vaa.edu.vn",
  "15102002@gmail.com"
];

const appFirebase = initializeApp(firebaseConfig);
const db = getFirestore(appFirebase);
const auth = getAuth();
const provider = new GoogleAuthProvider();

const emailInput = document.getElementById("email");
const passInput = document.getElementById("password");
const loginBtn = document.getElementById("loginBtn");
const googleBtn = document.getElementById("googleBtn");
const logoutBtn = document.getElementById("logoutBtn");
const authBox = document.getElementById("authBox");
const app = document.getElementById("app");
const totalKmSpan = document.getElementById("totalKm");
const monthKmSpan = document.getElementById("monthKm");
const progressFill = document.getElementById("progressFill");
const streakSpan = document.getElementById("streak");
const goalInput = document.getElementById("goalInput");
const chain = document.getElementById("chain");

let user=null, data=[];

loginBtn.onclick=()=>{
  signInWithEmailAndPassword(auth, emailInput.value, passInput.value)
  .catch(e=>alert(e.message));
};

googleBtn.onclick=()=>signInWithPopup(auth,provider);
logoutBtn.onclick=()=>signOut(auth);

onAuthStateChanged(auth, async(u)=>{
  if(u){

    if(!ALLOWED_EMAILS.includes(u.email.toLowerCase().trim())){
      alert("B蘯｡n khﾃｴng cﾃｳ quy盻］ truy c蘯ｭp app nﾃy!");
      await signOut(auth);
      return;
    }

    user=u;
    authBox.style.display="none";
    logoutBtn.style.display="inline-block";
    app.style.display="block";

    const snap=await getDoc(doc(db,"runs",user.uid));
    if(snap.exists()){
      const d=snap.data();
      data=d.data||[];
      goalInput.value=d.goal||100;
    } else { data=[]; goalInput.value=100; }

    render();
  }
});

function saveOnline(){ if(user) setDoc(doc(db,"runs",user.uid),{data,goal:goalInput.value}); }

window.addRun=function(){
  let date=new Date(dateInput.value).toDateString();
  let km=parseFloat(kmInput.value);
  let time=parseInt(timeInput.value);
  if(!dateInput.value||isNaN(km)||isNaN(time))return;
  data=data.filter(d=>d.date!==date);
  data.push({date,km,time});
  saveOnline(); render();
}

function render(){
  chain.innerHTML="";
  let total=0,monthKm=0,streak=0,now=new Date();

  data.forEach(d=>{
    total+=d.km;
    let dt=new Date(d.date);
    if(dt.getMonth()===now.getMonth()&&dt.getFullYear()===now.getFullYear())monthKm+=d.km;
  });

  totalKmSpan.innerText=total.toFixed(1);
  monthKmSpan.innerText=monthKm.toFixed(1);
  progressFill.style.width=Math.min((monthKm/(goalInput.value||100))*100,100)+"%";

  let map={}; data.forEach(d=>map[d.date]=d);
  for(let i=29;i>=0;i--){
    let d=new Date(); d.setDate(d.getDate()-i);
    let ds=d.toDateString(); let rec=map[ds];
    let div=document.createElement("div");
    div.className="day "+(rec?(rec.km>=10?"green":"red"):"red");
    div.innerHTML=rec?rec.km:"0";
    chain.appendChild(div);
  }
}
</script>
</body>
</html>
