<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Run Streak Private</title>
<style>
body { font-family: Arial; background:#0f172a; color:white; text-align:center; }
h1 { color:#38bdf8; }
.chain { display:flex; flex-wrap:wrap; justify-content:center; max-width:800px; margin:30px auto; gap:8px; }
.day { width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; }
.green { background:#22c55e; }
.red { background:#7f1d1d; }
</style>
</head>
<body>

<h1>ğŸ”’ Run Streak (Private)</h1>

<button id="googleBtn">ğŸ” ÄÄƒng nháº­p báº±ng Google</button>
<button id="logoutBtn" style="display:none;">ğŸšª ÄÄƒng xuáº¥t</button>

<div id="app" style="display:none;">
  <div>Tá»•ng km: <span id="totalKm">0</span> | Streak: <span id="streak">0</span></div>
  <input type="date" id="dateInput">
  <input type="number" id="kmInput" placeholder="Km">
  <input type="number" id="timeInput" placeholder="PhÃºt">
  <button onclick="addRun()">LÆ°u</button>
  <div class="chain" id="chain"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCgwqXrG0MzYZxWHmaNgcAE1h5HG0zNhSI",
  authDomain: "runm2026.firebaseapp.com",
  projectId: "runm2026",
  storageBucket: "runm2026.firebasestorage.app",
  messagingSenderId: "353845948909",
  appId: "1:353845948909:web:b0d3c35408009119a7b7e4"
};

const ALLOWED_EMAIL = "2051200028@vaa.edu.vn";

const appFirebase = initializeApp(firebaseConfig);
const db = getFirestore(appFirebase);
const auth = getAuth();
const provider = new GoogleAuthProvider();

const googleBtn = document.getElementById("googleBtn");
const logoutBtn = document.getElementById("logoutBtn");
const app = document.getElementById("app");
const chain = document.getElementById("chain");

let user=null, data=[];

googleBtn.onclick=()=>signInWithPopup(auth,provider);
logoutBtn.onclick=()=>signOut(auth);

onAuthStateChanged(auth, async(u)=>{
  if(u){

    if(u.email.toLowerCase().trim() !== ALLOWED_EMAIL.toLowerCase()){
      alert("Báº¡n khÃ´ng cÃ³ quyá»n truy cáº­p app nÃ y!");
      await signOut(auth);
      return;
    }

    user=u;
    googleBtn.style.display="none";
    logoutBtn.style.display="inline-block";
    app.style.display="block";

    const snap=await getDoc(doc(db,"runs",user.uid));
    if(snap.exists()) data=snap.data().data||[];
    render();
  }
});

function saveOnline(){ if(user) setDoc(doc(db,"runs",user.uid),{data}); }

window.addRun=function(){
  let date=new Date(dateInput.value).toDateString();
  let km=parseFloat(kmInput.value);
  let time=parseInt(timeInput.value);
  if(!dateInput.value||isNaN(km)||isNaN(time))return;
  data=data.filter(d=>d.date!==date);
  data.push({date,km,time});
  saveOnline(); render();
}

function render(){
  chain.innerHTML="";
  let map={}; data.forEach(d=>map[d.date]=d);
  for(let i=29;i>=0;i--){
    let d=new Date(); d.setDate(d.getDate()-i);
    let ds=d.toDateString(); let rec=map[ds];
    let div=document.createElement("div");
    div.className="day "+(rec?(rec.km>=10?"green":"red"):"red");
    div.innerHTML=rec?rec.km:"0";
    chain.appendChild(div);
  }
}
</script>
</body>
</html>
